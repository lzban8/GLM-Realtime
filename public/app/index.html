<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/app/realtime-2a7e23b3.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GLM-Realtime</title>
    <style>
      #debug-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        font-family: monospace;
        max-height: 80vh;
        overflow-y: auto;
      }
      .error-message {
        color: red;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid red;
        background: #fff;
      }
      .debug-section {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .debug-button {
        margin: 5px;
        padding: 5px 10px;
        background: #eee;
        border: 1px solid #ccc;
        cursor: pointer;
      }
    </style>
    <script>
      window.errors = [];
      window.debugLogs = [];

      function log(type, ...args) {
        const time = new Date().toISOString();
        window.debugLogs.push({ type, time, args });
        console.log(`[${type}]`, ...args);
        updateDebugInfo();
      }

      window.onerror = function(msg, url, line, col, error) {
        console.error('Error:', msg, '\nurl:', url, '\nline:', line);
        const errorInfo = { msg, url, line, col, stack: error?.stack };
        window.errors.push(errorInfo);
        log('error', errorInfo);
        return false;
      };

      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled Promise Rejection:', event.reason);
        const errorInfo = {
          msg: 'Unhandled Promise Rejection',
          detail: event.reason?.message || event.reason,
          stack: event.reason?.stack
        };
        window.errors.push(errorInfo);
        log('promise-error', errorInfo);
      });

      function inspectVue() {
        try {
          const app = document.getElementById('app');
          const vueInstance = app.__vue_app__;
          log('vue-inspect', {
            hasVueInstance: !!vueInstance,
            appElement: {
              innerHTML: app.innerHTML,
              childNodes: app.childNodes.length,
              attributes: Array.from(app.attributes || []).map(attr => `${attr.name}=${attr.value}`),
            },
            vueGlobals: {
              Vue: !!window.Vue,
              createApp: !!window.createApp,
              defineComponent: !!window.defineComponent,
            },
            windowKeys: Object.keys(window).filter(key => key.toLowerCase().includes('vue')),
          });
        } catch (e) {
          log('vue-inspect-error', e);
        }
      }

      function checkModules() {
        try {
          log('modules-check', {
            moduleScripts: Array.from(document.querySelectorAll('script[type="module"]')).map(script => ({
              src: script.src,
              async: script.async,
              defer: script.defer,
              crossOrigin: script.crossOrigin,
            })),
            importMeta: !!window.import,
            moduleSupport: 'noModule' in document.createElement('script'),
          });
        } catch (e) {
          log('modules-check-error', e);
        }
      }

      function updateDebugInfo() {
        const debugContainer = document.getElementById('debug-container');
        if (!debugContainer) return;

        let html = `
          <div class="debug-section">
            <div>Path: ${window.location.pathname}</div>
            <div>Time: ${new Date().toISOString()}</div>
            <div>Vue Ready: ${window.__VUE_APP_READY ? 'Yes' : 'No'}</div>
            <div>App Element: ${document.getElementById('app') ? 'Found' : 'Not Found'}</div>
            <div>
              <button class="debug-button" onclick="inspectVue()">Inspect Vue</button>
              <button class="debug-button" onclick="checkModules()">Check Modules</button>
              <button class="debug-button" onclick="window.location.reload(true)">Hard Reload</button>
            </div>
            <div>Scripts Loaded:</div>
            <ul>
              ${Array.from(document.scripts).map(script => 
                `<li>${script.src || 'inline'} - ${script.type || 'default'}</li>`
              ).join('')}
            </ul>
          </div>
        `;
        
        if (window.errors.length > 0) {
          html += `
            <div class="debug-section">
              <strong>Errors (${window.errors.length}):</strong>
              ${window.errors.map((error, index) => `
                <div class="error-message">
                  <div>Error ${index + 1}:</div>
                  <div>Message: ${error.msg}</div>
                  <div>Location: ${error.url}:${error.line}</div>
                  ${error.stack ? `<pre>${error.stack}</pre>` : ''}
                  ${error.detail ? `<div>Detail: ${error.detail}</div>` : ''}
                </div>
              `).join('')}
            </div>
          `;
        }

        if (window.debugLogs.length > 0) {
          html += `
            <div class="debug-section">
              <strong>Debug Logs (${window.debugLogs.length}):</strong>
              <pre>${window.debugLogs.map(log => 
                `[${log.time}] [${log.type}] ${JSON.stringify(log.args)}`
              ).join('\n')}</pre>
            </div>
          `;
        }

        debugContainer.innerHTML = html;
      }

      // 监听Vue应用就绪状态
      Object.defineProperty(window, '__VUE_APP_READY', {
        set(value) {
          this._vueReady = value;
          log('vue-ready', value);
          updateDebugInfo();
        },
        get() {
          return this._vueReady;
        }
      });

      // 定期更新调试信息
      setInterval(updateDebugInfo, 1000);

      // 记录初始化完成
      log('init', 'Debug system initialized');
    </script>
  </head>
  <body>
    <div id="debug-container">
      Initializing...
    </div>
    <div id="app"></div>
    <script>
      log('pre-load', 'Starting to load main script');
    </script>
    <script type="module" src="/app/index-b217dc70.js" onerror="log('script-error', 'Failed to load main script')" onload="log('script-loaded', 'Main script loaded successfully')"></script>
    <link rel="stylesheet" href="/app/index-6c76d44e.css" onerror="log('css-error', 'Failed to load stylesheet')" onload="log('css-loaded', 'Stylesheet loaded successfully')">
  </body>
</html> 